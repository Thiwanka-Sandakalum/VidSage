# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - vidsage-backend

on:
  push:
    branches:
      - main
    paths:
      - "Apps/api/**"
      - ".github/workflows/main_vidsage-backend.yml"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Apps/api
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('Apps/api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Free up GitHub Actions runner disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "Disk space after cleanup:"
          df -h

      - name: Clean Python cache files
        run: |
          echo "Cleaning __pycache__ directories..."
          find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete
          find . -type f -name "*.pyo" -delete
          echo "Cache cleaned!"

      # By default, Azure Oryx handles dependency installation during deployment
      # We skip local build to save time and disk space
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            Apps/api
            !Apps/api/.git/
            !Apps/api/.github/
            !Apps/api/__pycache__/
            !Apps/api/**/__pycache__/
            !Apps/api/*.pyc
            !Apps/api/**/*.pyc
            !Apps/api/.pytest_cache/
            !Apps/api/.vscode/
            !Apps/api/tests/
            !Apps/api/antenv/
            !Apps/api/*.egg-info/
            !Apps/api/.coverage
            !Apps/api/htmlcov/
            !Apps/api/TEST_SUMMARY.md

  deploy:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: ./app

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_F82AE6D372134AE68D09F60FCE445502 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_4A726B26BD7E459A97EA713D89C0DABD }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_ABAEF6F15D95410C8FDDBF29B1F087C5 }}

      - name: "Deploy to Azure Web App"
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: "vidsage-backend"
          slot-name: "Production"
          package: ./app
          startup-command: "gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:8000 --timeout 600"

      - name: Check deployment status
        if: always()
        run: |
          echo "Deployment status: ${{ steps.deploy-to-webapp.outcome }}"
          if [ "${{ steps.deploy-to-webapp.outcome }}" != "success" ]; then
            echo "❌ Deployment failed or was cancelled"
            exit 1
          else
            echo "✅ Deployment successful!"
          fi
