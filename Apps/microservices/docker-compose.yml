version: "3.8"

services:
  # ============================================
  # Infrastructure Services
  # ============================================

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: vidsage-rabbitmq
    ports:
      - "5672:5672" # AMQP port
      - "15672:15672" # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - vidsage-network

  # ============================================
  # Microservices
  # ============================================

  gateway-api:
    build:
      context: .
      dockerfile: gateway-api/Dockerfile
    container_name: vidsage-gateway
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-vidsage}
      - MONGODB_COLLECTION=${MONGODB_COLLECTION:-video_embeddings}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - TRANSCRIPT_SERVICE_URL=http://transcript-service:8001
      - EMBEDDING_SERVICE_URL=http://embedding-service:8002
      - GENERATION_SERVICE_URL=http://generation-service:8003
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - vidsage-network
    restart: unless-stopped

  gateway-worker:
    build:
      context: .
      dockerfile: gateway-api/Dockerfile
    container_name: vidsage-gateway-worker
    command: ["python", "gateway-api/worker.py"]
    environment:
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-vidsage}
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - vidsage-network
    restart: unless-stopped

  transcript-service:
    build:
      context: .
      dockerfile: transcript-service/Dockerfile
    container_name: vidsage-transcript
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - TRANSCRIPT_SERVICE_URL=http://transcript-service:8001
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - vidsage-network
    restart: unless-stopped

  transcript-worker:
    build:
      context: .
      dockerfile: transcript-service/Dockerfile
    container_name: vidsage-transcript-worker
    command: ["python", "transcript-service/worker.py"]
    environment:
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - TRANSCRIPT_SERVICE_URL=http://transcript-service:8001
    depends_on:
      rabbitmq:
        condition: service_healthy
      transcript-service:
        condition: service_started
    networks:
      - vidsage-network
    restart: unless-stopped

  embedding-service:
    build:
      context: .
      dockerfile: embedding-service/Dockerfile
    container_name: vidsage-embedding
    ports:
      - "8002:8002"
    environment:
      - PORT=8002
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-vidsage}
      - MONGODB_COLLECTION=${MONGODB_COLLECTION:-video_embeddings}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - EMBEDDING_SERVICE_URL=http://embedding-service:8002
      - CHUNK_SIZE=${CHUNK_SIZE:-500}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-100}
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - vidsage-network
    restart: unless-stopped

  embedding-worker:
    build:
      context: .
      dockerfile: embedding-service/Dockerfile
    container_name: vidsage-embedding-worker
    command: ["python", "embedding-service/worker.py"]
    environment:
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-vidsage}
      - MONGODB_COLLECTION=${MONGODB_COLLECTION:-video_embeddings}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - EMBEDDING_SERVICE_URL=http://embedding-service:8002
      - CHUNK_SIZE=${CHUNK_SIZE:-500}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-100}
    depends_on:
      rabbitmq:
        condition: service_healthy
      embedding-service:
        condition: service_started
    networks:
      - vidsage-network
    restart: unless-stopped

  generation-service:
    build:
      context: .
      dockerfile: generation-service/Dockerfile
    container_name: vidsage-generation
    ports:
      - "8003:8003"
    environment:
      - PORT=8003
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-vidsage}
      - MONGODB_COLLECTION=${MONGODB_COLLECTION:-video_embeddings}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.0-flash-lite}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.3}
      - LLM_MAX_OUTPUT_TOKENS=${LLM_MAX_OUTPUT_TOKENS:-1024}
    networks:
      - vidsage-network
    restart: unless-stopped

# ============================================
# Volumes
# ============================================

volumes:
  rabbitmq-data:
    driver: local

# ============================================
# Networks
# ============================================

networks:
  vidsage-network:
    driver: bridge
